- name: D√©ploiement ClamAV Automation (scan + timers systemd)
  hosts: all
  become: yes
  become_method: sudo
  become_user: root
  become_flags: '-H'

  vars:
    ansible_remote_tmp: /tmp/.ansible

  environment:
    ANSIBLE_REMOTE_TMP: /tmp/.ansible
    ANSIBLE_LOCAL_TMP: /tmp/.ansible
    ANSIBLE_HOST_KEY_CHECKING: "False"

  tasks:

    # ------------------------------------------------------------------
    # ANSIBLE TMP (OBLIGATOIRE POUR SEMAPHORE)
    # ------------------------------------------------------------------
    - name: Cr√©er dossier temp Ansible
      file:
        path: /tmp/.ansible
        state: directory
        mode: '0777'

    # ------------------------------------------------------------------
    # DOSSIERS CLAMAV
    # ------------------------------------------------------------------
    - name: Cr√©er les dossiers ClamAV
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - /opt/clamav/scripts
        - /var/log/clamav

    # ------------------------------------------------------------------
    # SCRIPTS
    # ------------------------------------------------------------------
    - name: Copier les scripts ClamAV
      copy:
        src: "{{ item }}"
        dest: /opt/clamav/scripts/
        owner: root
        group: root
        mode: '0755'
      loop:
        - scripts/clamav_scan.sh
        - scripts/clamav_update.sh

    # ------------------------------------------------------------------
    # LOGS
    # ------------------------------------------------------------------
    - name: Cr√©er les fichiers de log
      file:
        path: "{{ item }}"
        state: touch
        owner: root
        group: root
        mode: '0600'
      loop:
        - /var/log/clamav/clamav-scan.log
        - /var/log/clamav/freshclam.log

    # ------------------------------------------------------------------
    # SYSTEMD SERVICES
    # ------------------------------------------------------------------
    - name: Installer services systemd ClamAV
      copy:
        src: "{{ item }}"
        dest: /etc/systemd/system/
        owner: root
        group: root
        mode: '0644'
      loop:
        - systemd/clamav-scan.service
        - systemd/clamav-update.service

    # ------------------------------------------------------------------
    # SYSTEMD TIMERS
    # ------------------------------------------------------------------
    - name: Installer timers systemd ClamAV
      copy:
        src: "{{ item }}"
        dest: /etc/systemd/system/
        owner: root
        group: root
        mode: '0644'
      loop:
        - systemd/clamav-scan.timer
        - systemd/clamav-update.timer

    # ------------------------------------------------------------------
    # RELOAD + ENABLE
    # ------------------------------------------------------------------
    - name: Reload systemd
      command: systemctl daemon-reexec

    - name: Activer et d√©marrer les timers ClamAV
      systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
      loop:
        - clamav-scan.timer
        - clamav-update.timer

    # ------------------------------------------------------------------
    # MESSAGE FINAL
    # ------------------------------------------------------------------
    - name: D√©ploiement termin√©
      debug:
        msg: |
          ‚úÖ ClamAV d√©ploy√© avec succ√®s (systemd timers)

          ‚è± Timers actifs :
            - clamav-scan.timer
            - clamav-update.timer

          üîç V√©rification :
            systemctl list-timers | grep clamav

          ‚ñ∂ Test imm√©diat :
            systemctl start clamav-scan.service
            systemctl start clamav-update.service

          üìÇ Logs :
            - /var/log/clamav/clamav-scan.log
            - /var/log/clamav/freshclam.log

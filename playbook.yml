---
- name: D√©ploiement ClamAV Automation (scan + cron)
  hosts: all
  become: yes
  become_method: sudo
  become_user: root
  become_flags: '-H'

  vars:
    ansible_remote_tmp: /tmp/.ansible

  environment:
    ANSIBLE_REMOTE_TEMP: /tmp/.ansible
    ANSIBLE_HOST_KEY_CHECKING: "False"

  tasks:

    - name: Cr√©er dossier temp Ansible (pr√©vention erreur)
      file:
        path: /tmp/.ansible
        state: directory
        mode: '0777'

    - name: Cr√©er les dossiers ClamAV
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - /opt/clamav/scripts
        - /var/log/clamav

    - name: Copier les scripts ClamAV
      copy:
        src: "{{ item }}"
        dest: /opt/clamav/scripts/
        owner: root
        group: root
        mode: '0755'
      loop:
        - scripts/clamav_scan.sh
        - scripts/clamav_update.sh

    - name: Copier les cron ClamAV
      copy:
        src: "{{ item }}"
        dest: /etc/cron.d/
        owner: root
        group: root
        mode: '0644'
      loop:
        - cron/clamav_scan.cron
        - cron/clamav_update.cron

    - name: Cr√©er les fichiers de log
      file:
        path: "{{ item }}"
        state: touch
        owner: root
        group: root
        mode: '0600'
      loop:
        - /var/log/clamav/clamav-scan.log
        - /var/log/clamav/freshclam.log

    - name: Ajouter note pour tests manuels
      debug:
        msg: |
          ‚úÖ D√©ploiement termin√©.
          ‚ö° Pour v√©rifier manuellement :
          chmod +x /opt/clamav/scripts/clamav_scan.sh
          chmod +x /opt/clamav/scripts/clamav_update.sh
          bash /opt/clamav/scripts/clamav_scan.sh
          bash /opt/clamav/scripts/clamav_update.sh
          üìÇ Les logs se trouvent dans :
            - /var/log/clamav/clamav-scan.log
            - /var/log/clamav/freshclam.log
          Chaque ligne indique la date, le hostname et le statut.

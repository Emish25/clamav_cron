---
- name: Deploiement ClamAV Automation (scan + cron)
  hosts: all
  become: yes
  become_method: sudo
  become_user: root
  become_flags: '-H'

  vars:
    ansible_remote_tmp: /tmp/.ansible

  environment:
    ANSIBLE_REMOTE_TEMP: /tmp/.ansible
    ANSIBLE_HOST_KEY_CHECKING: "False"

  tasks:

    - name: Creer dossier temp Ansible (pr√©vention erreur)
      file:
        path: /tmp/.ansible
        state: directory
        mode: '0777'

    - name: Creer les dossiers ClamAV
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - /opt/clamav/scripts
        - /var/log/clamav

    - name: Copier les scripts ClamAV
      copy:
        src: "{{ item }}"
        dest: /opt/clamav/scripts/
        owner: root
        group: root
        mode: '0755'
      loop:
        - files/clamav_scan.sh
        - files/clamav_update.sh

    - name: Copier les cron ClamAV
      copy:
        src: "{{ item }}"
        dest: /etc/cron.d/
        owner: root
        group: root
        mode: '0644'
      loop:
        - clamav_scan.cron
        - clamav_update.cron

    - name: Creer les fichiers de log
      file:
        path: "{{ item }}"
        state: touch
        owner: root
        group: root
        mode: '0600'
      loop:
        - /var/log/clamav/clamav-scan.log
        - /var/log/clamav/freshclam.log
